# run on x01
# set up airflow -> airflow via conda first, then pip airflow, then mysqlclient, then submit_hpc
pip install apache-airflow --upgrade
conda activate airflow
export C_FORCE_ROOT='true'
export AIRFLOW_HOME=/dartfs/rc/lab/V/VaickusL_slow/users/jlevy/arctic_ai/prototype/ArcticAI_Prototype/workflow/airflow
cd /dartfs/rc/lab/V/VaickusL_slow/users/jlevy/arctic_ai/prototype/ArcticAI_Prototype/workflow
https://rc.dartmouth.edu/index.php/hrf_faq/accessing-your-research-mysql-database/
https://www.hpc.iastate.edu/guides/containers/mysql-server
singularity pull --name mysql.simg shub://ISU-HPC/mysql
singularity instance start --bind ${HOME}     --bind ${PWD}/mysql/var/lib/mysql/:/var/lib/mysql     --bind ${PWD}/mysql/run/mysqld:/run/mysqld     ./mysql.simg mysql
nano /dartfs-hpc/rc/home/w/f003k8w/.my.cnf
# ^^^generate tmp dir https://stackoverflow.com/questions/8633373/mysql-cant-create-write-to-file-error13
# ^^^generate explicit_defaults_for_timestamp = 1
singularity run instance://mysql
singularity exec instance://mysql create_remote_admin_user.sh
username: remote_usr
password: oa51aQ0T
#sql_alchemy_conn = mysql://root:airflow@localhost/airflow?unix_socket=/dartfs/rc/lab/V/VaickusL_slow/users/jlevy/arctic_ai/prototype/ArcticAI_Prototype/workflow/mysql/run/mysqld/mysqld.sock
nano airflow/airflow.cfg
sql_alchemy_conn = mysql+mysqldb://remote_usr:Lk9r9U0-@localhost/airflow?unix_socket=mysql/run/mysqld/mysqld.sock
nano airflow/airflow.cfg
executor = LocalExecutor
openssl rand -hex 30 # lookup if stuck
secret_key = 78455bc775c77ee544de4cd6b862630cbc4ed890491daabedf34cf78e68c
cookie_samesite = Lax
# https://raw.githubusercontent.com/apache/airflow/51d955787b009b9e3a88f3e9b4ca1a3933a061f0/airflow/config_templates/default_webserver_config.py
nano airflow/webserver_config.py
CSRF_ENABLED = True


mysql -S mysql/run/mysqld/mysqld.sock
CREATE DATABASE airflow CHARACTER SET utf8 COLLATE utf8_unicode_ci;
CREATE USER 'airflow' IDENTIFIED BY 'airflow';
GRANT ALL PRIVILEGES ON airflow.* TO 'airflow';
# singularity instance stop mysql

airflow db init
# airflow users delete --username admin
airflow users create \
    --username admin \
    --firstname Joshua \
    --lastname Levy \
    --role Admin \
    --email joshualevy44@yahoo.com
Password: password

airflow scheduler > scheduler.log &
airflow webserver --port 5559
###########
OLD
https://hub.docker.com/_/mysql
singularity pull docker://mysql
singularity shell --writable-tmpfs -B /dartfs/rc/lab/V/VaickusL_slow/ -B $(pwd)/mysql_db/:/var/lib/mysql mysql_latest.sif
mysqld_safe --datadir=/var/lib/mysql &
mysql_install_db
mysql_secure_installation
password
